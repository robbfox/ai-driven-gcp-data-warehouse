# .github/workflows/your-workflow-name.yml

name: 'Test, Plan, and Deploy Infrastructure'

on:
  push:
    branches:
      - master
  pull_request:

permissions:
  contents: 'read'
  id-token: 'write'

jobs:
  test-and-deploy:
    name: 'Test and Deploy'
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout repository code
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 2. Authenticate to Google Cloud
    - name: Authenticate to Google Cloud
      id: auth
      uses: 'google-github-actions/auth@v1'
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    # 3. Set up Python and install dependencies
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install Python Dependencies
      run: pip install -r requirements.txt

    # 4. Run Python tests
    # THIS STEP STILL NEEDS GCP_PROJECT_ID FOR THE PYTHON CLIENT
    - name: Run Python Tests
      run: |
        export PYTHONPATH=$(pwd)
        pytest src/tests/test_load_data.py
      env:
        GCS_BUCKET_NAME: 'robb-gemini-bq'
        GCP_PROJECT_ID: '${{ secrets.GCP_PROJECT_ID }}'

    # 5. Set up Terraform
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: '1.5.0'

    # 6. Terraform Init - No changes here
    - name: Terraform Init
      run: terraform init
      working-directory: ./terraform

    # 7. Terraform Plan - SIMPLIFIED
    - name: Terraform Plan
      # The -var flag is no longer needed because the project is hardcoded in main.tf
      run: terraform plan
      working-directory: ./terraform

      # Terraform format check
    - name: Terraform Format Check
      run: terraform fmt -check
      working-directory: ./terraform

      # Validate Terraform configuration files
    - name: Terraform Validate
      run: terraform validate
      working-directory: ./terraform
      

    # 8. Terraform Apply - SIMPLIFIED
    - name: Terraform Apply
      if: github.ref == 'refs/heads/master' && github.event_name == 'push'
      # The -var flag is no longer needed
      run: terraform apply -auto-approve
      working-directory: ./terraform

    # 9. Run the data loading script
    # THIS STEP STILL NEEDS GCP_PROJECT_ID FOR THE PYTHON CLIENT
    - name: Run Data Loading Script
      if: github.ref == 'refs/heads/master' && github.event_name == 'push'
      run: python src/load_data.py
      env:
        GCS_BUCKET_NAME: 'robb-gemini-bq'
        GCP_PROJECT_ID: '${{ secrets.GCP_PROJECT_ID }}'